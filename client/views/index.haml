!!! 5
%html
  %head
    %title Serious Business
    %link{:href => '/css/site.css', :media => 'screen', :rel => 'stylesheet', :type => 'text/css'}
    %script{:src => '/js/jquery-1.5.1.min.js', :type => 'text/javascript'}
    %script{:src => '/js/raphael-min.js', :type => 'text/javascript'}
    %script{:src => '/js/g.raphael-min.js', :type => 'text/javascript'}
    %script{:src => '/js/g.line-min.js', :type => 'text/javascript'}
    :javascript

      function range(n) {
        result = [];
        for (i = 0; i < n; i++) {
           result.push(i);
        };
        return result;
      };

      $(document).ready(function() {
        sensors = #{@sensors};
        $.each(sensors, function(sensor) {
          var labels = [];
          var values = [];

          // Collect values and labels
          $.each(sensors[sensor], function(i) {
            var details = $.parseJSON(sensors[sensor][i]);
            labels.push(details.date);
            values.push(details.output);
          });

          // Shorten dates for nice labels
          $.each(labels, function(i) {
            var label = labels[i];
            var label_date = new Date(label);
            labels[i] = label_date.getMonth() + '/' + label_date.getFullYear();
          });

          // Draw
          var chart = $('<div id="'+sensor+'">').appendTo('body');
          var r = Raphael(sensor, 640, 480);
          var fin = function () {
            this.flag = r.popup(this.x, this.y, this.value || "0").insertBefore(this);
          };
          var fout = function () {
            this.flag.animate({opacity: 0}, 300, function () {this.remove();});
          };
          r.text(200, 10, sensor).attr({"font-size": 20});
          chart = r.linechart(10, 10, 300, 220, range(values.length), values).hover(fin, fout);
          //chart.label(labels, true);
        });
      });

  %body
    %p=@sensors

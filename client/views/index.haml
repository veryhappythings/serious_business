!!! 5
%html
  %head
    %title Serious Business
    %link{:href => '/css/site.css', :media => 'screen', :rel => 'stylesheet', :type => 'text/css'}
    %script{:src => '/js/jquery-1.5.1.min.js', :type => 'text/javascript'}
    %script{:src => '/js/raphael-min.js', :type => 'text/javascript'}
    %script{:src => '/js/g.raphael-min.js', :type => 'text/javascript'}
    %script{:src => '/js/g.bar-min.js', :type => 'text/javascript'}
    :javascript
      $(document).ready(function() {
        sensors = #{@sensors};
        $.each(sensors, function(sensor) {
          var labels = [];
          var values = [];

          // Collect values and labels
          $.each(sensors[sensor], function(i) {
            var details = $.parseJSON(sensors[sensor][i]);
            labels.push(details.date);
            values.push(details.output);
          });

          // Shorten dates for nice labels
          $.each(labels, function(i) {
            var label = labels[i];
            var label_date = new Date(label);
            labels[i] = label_date.getMonth() + '/' + label_date.getFullYear();
          });

          // Draw
          var chart = $('<div id="'+sensor+'">').appendTo('body');
          var r = Raphael(sensor, 640, 480);
          var fin = function () {
            this.flag = r.g.popup(this.bar.x, this.bar.y, this.bar.value || "0").insertBefore(this);
          };
          var fout = function () {
            this.flag.animate({opacity: 0}, 300, function () {this.remove();});
          };
          r.g.txtattr.font = "12px 'Fontin Sans', Fontin-Sans, sans-serif";
          r.g.text(200, 10, sensor).attr({"font-size": 20});
          chart = r.g.barchart(10, 10, 300, 220, values, 0, {type: "sharp"}).hover(fin, fout);
          chart.label(labels, true);
        });
      });

  %body
    %p=@sensors
